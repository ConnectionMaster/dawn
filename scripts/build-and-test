#!/usr/bin/env bash

dawn_source_dir=$1
dawn_build_dir=$2
dawn_install_dir=$3
cg_source_dir=$4
build_jobs=24

# 1. Dawn
cmake -S $dawn_source_dir -B $dawn_build_dir \
    -DBUILD_TESTING=ON \
    -DCMAKE_INSTALL_PREFIX=$dawn_install_dir \
    ${@:5}

cmake --build $dawn_build_dir --parallel $build_jobs --target install

python -m pip install -e $dawn_source_dir/dawn

(cd $dawn_build_dir && ctest --output-on-failure --force-new-ctest-process)

# 2. Clang-GridTools
cmake -S $cg_source_dir -B $cg_source_dir/build \
    -DCMAKE_PREFIX_PATH=$dawn_install_dir \
    ${@:5}

cmake --build $cg_source_dir/build --config $build_type --parallel $build_jobs

# Run tests
(cd $cg_source_dir/build && ctest --output-on-failure --force-new-ctest-process)
